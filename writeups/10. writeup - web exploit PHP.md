### ðŸŸ¢ ping (100)
**Solve:**
User input is stored into a POST request variable called ip. This variable will be passed to php's shell_exec() function which takes in a command as a string and returns a single output also as a string. Try a few. We realize things like &, |, ; and space characters are banned. So we can't use them to chain two commands. Go research a little and find other ways to chain commands, like using the newline character %0A (url-encoded). 

Enter this:
`127.0.0.1%0Als`

Get the following output.
![[Captura de pantalla 2024-11-26 a las 14.49.01.png]]

There's a php flag file. We enter as URL: `offsec-chalbroker.osiris.cyber.nyu.edu:1503/f14g_cmdi.php` and the code runs. We see the flag rendered on the page. 

An alternative solution is to directly inject the command to `cat` the flag php file content. `cat` is forbidden, but we can use single-quotes to escape it: 
`127.0.0.1%0Ac'a't%09f14g_cmdi.php`

flag{now_you_have_command_to_my_army_snow!_e3a163e4db83ffaf}


**Trial-and-error Notes:**
- Allowed chars
	- &
		- && logical AND to chain the second one since ; is banned
		- Observation: & is ok but entering its URL-encoded value %26 says that the character is banned...
	- []
	- ls
	- { } curly braces
		- brace expansion
			- when try: {127.0.0.0,127.0.0.1}, only pings the second IP once
	- ${IFS} as space
- Denylist
	- ['cat', ';', space, '|', 'pwd', 'whoami', 'history', 'echo\']
- Trials
	- 
- observations
	- URL-encoded chars get interpretted as the char
		- %3B as ; which is still forbidden
	- Denylist based, not allow-list
		- denies if the input contains banned words or chars
			- feedback shows the first detected denied thing
	- %00
		- `<b>Warning</b>:  shell_exec(): NULL byte detected. Possible attack in <b>/var/www/html/ping.php</b> on line <b>35</b><br />`
	- Try on my local terminal: **ping 127.0.0.0&&ls**
		- keeps pinging, does not get onto ls
		- I think it's because ping is a continuous operation. 
		- I need an intermediate operation to stop the ping and then chain the desired command at the end.
			- Add a flag to ping command to ping just once then stop:
				- `ping -c 1 127.0.0.1&&ls` sent as as `ping${IFS}-c${IFS}1${IFS}127.0.0.1&&ls` because space is denied
					- Outcome: no result displayed...
					- Investigate: try on local terminal, this gives: **zsh: command not found: ping \t\n**
					- So the ${IFS} represents two chars together: \t\n
					- what about using tab %09?
						- -c%091%09127.0.0.1&&whoami
							- returns the ping output
							- weird bc whoami was supposedly banned
							- There must be some filtering done to the input?
				- Alternatives
					- **``echo {ping,127.0.0.1}``&&ls**
						- works to execute both commands but that space char after echo...
						- I'll also need to find a way to bypass echo which is a banned word




### locale-infiltrator (200)
What files can be uploaded?
- .php file renamed to .png
	- > Conclusion: Only check file-name extension, not magic bytes/MIME
After successful upload:
- brings me to: **upload_handler.php**
	- Is there a way to dump the src code of this page?
	- Where do they put uploaded files? !!!!!!!!!!!
		- S.t. I can navigate to it and execute
- I uploaded curr_dir.php.png onto the server
	- That contains malicious code that displays contents of current directory
	- Now I need to somehow include that file and cause it to run
Language of the page
- $lang=en or =fr
	- I think this is used to concatenate with a filepath to serve a .php page
	- If I manipulate the value of this param, I can potentially cause a specific .php to be served
Fishy behaviour
	- URL 
	http://offsec-chalbroker.osiris.cyber.nyu.edu:1501/upload_handler.php
	- ![[Captura de pantalla 2024-11-26 a las 16.22.32.png]]
### validator (100)
Topic: upload malicious file (file inclusion)
**Solve:**
- Part 1: Initial Observations on the webpage
	- Pages
		- index.php
		- about.php
		- contact.php
			- Enter name and email
			- Can upload file <= 500 KB
				- uploads to the directory: /profile_images
				- Only JPG, JPEG, and PNG images are allowed.
					- Even if the file has MIME-bypass header in the code, if it's .php, will not work.
					- Conclusion: must rename file to .png or .jpg
				- Tried uploading a text file renamed to suffix .png > not allowed still "Only images are allowed". Tried uploading "test.png.php" such that the file name includes png - did not work. 
					- Conclusion: MIME type filtering is in place. 
				- Summary of findings
					- Server checks file name extension: must end in .jpg or .png
						- Failed:
						- `val_hi.jpg.php`
					- Successful Uploads but can't find the file:
						- `a_hi.php%00.png%00.jpg`
					- Server also checks file MIME type: must have GIF89a; at the header of the php code
					- Cannot see executed code?? errored image
						- Goal: upload as .jpg but run as .php not image
						- `val_hi.php.jpg` will try to display it as image but fails 
						- `val_hi.php%00.png` becomes `val_hi.php.png`
						- `val_hi.php\x00.png` becomes `x00.png`
						- `a_hi.php;.png`
					- Filters by whitelist, not denylist
						- does not ban words like .php
						- must include .jpg / .jpeg / .png at the END
- Part 2: Plan our attack
	- **Key Idea:** write .php file to leak contents of flag.txt presumably in root directory. Upload it as an image file. Navigate to that image file by entering its filepath in the browser's search bar. The code executes and we get the flag.
	- Recon
		- leak source code for contact.php page to see how upload is processed? Cannot. Because this simply navigates to the page, not storing the page in a URL query ?page= which then uses require_once() to run the code
	- Steps
		- Write .php file to display contents of flag.txt, presumably in root directory (same as index.php)
			- Why does the upload directory matter? 
				- Need to go up a level to get to root directory
				- 
		- Create valid picture hosting this PHP code. 
			- 
		- Upload this picture 
		- Don't I need to upload another file to execute this picture's code?
			- Actually no. Once I upload this picture file, I just have to type in its file path to get it to show on the browser. Which means that if this picture was executable php code, just by entering its filepath in the search bar would cause the php server to run the code
	- Problems
		- can upload .png, .php.png containing malicious php code
			- When navigate to this uploaded file, browser cannot display image
				- Solution: upload a .png file. Have it be an actual image. But insert php code at the end of the png file: 
					- `echo '<?php echo "hey yo"; ?>' >> image.png

### ðŸŸ¢ LFI: local file inclusion (100)
**Solve:**
This is a news website. From the URL, we see the parameter `page` in the query string, set to whatever page we are viewing. The page is generated by executing code from the corresponding php file specified by the value of parameter `page`. Let's try messing around with the parameter, setting it to something like "random". Enter and we receive: 

```
**Warning**: require_once(random.php): failed to open stream: No such file or directory in **/var/www/html/index.php** on line **32**  
  
**Fatal error**: require_once(): Failed opening required 'random.php' (include_path='.:/usr/local/lib/php') in **/var/www/html/index.php** on line **32**
```

This indicates the value of `page` is appended to `.php` before the file is inserted and executed. It tells us we should enter the desired file name without `.php`.

Let's try to set `page=flag` to see if there's a flag file. We get the output "Can you find the flag?". This indicates the file does exist. It'll be helpful to leak the source code of this file. Do that by using php conversion filters, which are applied to the file to be included BEFORE its code is then executed. 

Enter the following URL:
http://offsec-chalbroker.osiris.cyber.nyu.edu:1500/index.php?page=php://filter/convert.base64-encode/resource=flag

We will get the source code of `flag.php`, base64-encoded: `PD9waHAKLy9mbGFne1cwd19MRklfMXNfQzBPbCFfMmMyMmM0MTVkMmU3OTk3Zn0KPz4KQ2FuIHlvdSBmaW5kIHRoZSBmbGFnPw==`

Let's decode this string in the terminal using `echo "PD9waHAKLy9mbGFne1cwd19MRklfMXNfQzBPbCFfMmMyMmM0MTVkMmU3OTk3Zn0KPz4KQ2FuIHlvdSBmaW5kIHRoZSBmbGFnPw==" | base64 -d`

The output is:
```php
<?php
//flag{W0w_LFI_1s_C0Ol!_2c22c415d2e7997f}
?>

Can you find the flag?%
```

There's the flag, hiding in the comment!
flag{W0w_LFI_1s_C0Ol!_2c22c415d2e7997f}


